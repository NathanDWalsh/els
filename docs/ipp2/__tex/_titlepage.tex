% In case you're wondering, the % signs ending every line on the titlepage are to suppress all whitespace and unintentional ending of paragarphs
\bookmarksetup{startatroot}\bookmark[named=FirstPage, level=0]{Title page}\bookmarksetup{startatroot}%

\newcommand*{\IPPTITLE}{\normalfont\titlepageFontSans\LARGE{}Informatics Project Proposal~\the\year}%
\newcommand*{\TITLEPAGETITLE}{\normalfont\titlepageFontSans\Huge\bfseries\TITLE}%
\newcommand*{\TITLEPAGEAUTHOR}{\normalfont\titlepageFontSerif\huge\AUTHOR}%
\newcommand*{\SCHOOL}{School of Informatics}%
\newcommand*{\INSTITUTION}{University of Edinburgh}%
\newcommand*{\SUPERVISORROLE}{Supervisor}%
\newcommand*{\IPPTUTORROLE}{IPP~Tutor}%


\newsavebox{\ippbox}%
\savebox{\ippbox}{%
  \begin{varwidth}{\linewidth}%
    \centering\IPPTITLE%
  \end{varwidth}%
}%

\newsavebox{\titlebox}%
\savebox{\titlebox}{%
  \begin{varwidth}{\linewidth}%
    \centering\TITLEPAGETITLE%
  \end{varwidth}%
}%

\newsavebox{\authorsbox}%
\savebox{\authorsbox}{%
  \begin{varwidth}{\linewidth}%
    \centering\TITLEPAGEAUTHOR%
  \end{varwidth}%
}%

% \ifundef{\PROJECTTYPE}%
%   {}
%   {%
%     \newsavebox{\projecttypebox}%
%     \savebox{\projecttypebox}{%
%       \begin{varwidth}{\linewidth}%
%         \begin{singlespace}%
%           \centering\LARGE\titlepageFontSerif\addfontfeatures{Numbers={Proportional,Lining}}\PROJECTTYPE%
%         \end{singlespace}%
%       \end{varwidth}%
%     }%
%   }%

% \ifundef{\PROJECTNOTE}%
%   {}%
%   {%
%     \newsavebox{\projectnotebox}%
%     \savebox{\projectnotebox}{%
%       \begin{varwidth}{\linewidth}%
%         \begin{singlespace}%
%           \centering\normalfont\LARGE\bfseries\titlepageFontSerif\addfontfeatures{Numbers={Proportional,Lining}}\PROJECTNOTE%
%         \end{singlespace}%
%       \end{varwidth}%
%     }%
%   }%

\newsavebox{\abstractbox}%
\savebox{\abstractbox}{%
  \begin{varwidth}{.8\linewidth}%
    \normalfont\titlepageFontSerif\setstretch{1.2}\addfontfeatures{Numbers={Proportional,Lining}}\input{abstract}%
  \end{varwidth}%
}%

\newsavebox{\staffbox}%
\savebox{\staffbox}{%
  \normalfont\titlepageFontSerif\Large%
  \begin{varwidth}[t]{0.45\linewidth}%
    \begin{flushleft}%
        \begin{singlespace}\SUPERVISORROLE\par\bfseries\SUPERVISOR\par\end{singlespace}%
    \end{flushleft}%
  \end{varwidth}%
  \hspace*{6em}%
  \begin{varwidth}[t]{0.45\linewidth}%
    \begin{flushright}%
      \begin{singlespace}\IPPTUTORROLE\par\bfseries\IPPTUTOR\par\end{singlespace}%
    \end{flushright}%
  \end{varwidth}%
}%

\newcommand*{\titleRuleWidth}{0.2ex}%
\newcommand*{\titleRule}{\rule{\wd\titlebox}{\titleRuleWidth}}%
\newcommand*{\ippRule}{\rule{\wd\ippbox}{\titleRuleWidth}}%
\newcommand*{\authorsRule}{\rule{\wd\authorsbox}{\titleRuleWidth}}%

\newgeometry{margin=1cm}%
  \begin{singlespace}%
    \centering%
    \vspace*{\fill}%
    \titleRule\\[1.5\baselineskip]%
    \thispagestyle{empty}%
    \usebox{\ippbox}\par%
    \vspace*{1\baselineskip}%
    \ippRule\\[1\baselineskip]%
    \vspace*{1\baselineskip}%
    \usebox{\titlebox}\par%
    \vspace*{1.5\baselineskip}%
    \authorsRule\\[1.4\baselineskip]%
    \usebox{\authorsbox}\par%
    \vspace*{\baselineskip}%
    \titleRule\\%[4\baselineskip]%
    \ifundef{\PROJECTTYPE}{}{\ifundef{\PROJECTNOTE}{\vspace*{4\baselineskip}}{\vspace*{3\baselineskip}}\usebox{\projecttypebox}\par}%
    \ifundef{\PROJECTNOTE}{}{\ifundef{\PROJECTTYPE}{\vspace*{4\baselineskip}}{\vspace*{3\baselineskip}}\usebox{\projectnotebox}\par}%
    \vspace*{\fill}%
    \usebox{\abstractbox}\par%
    % \vspace*{\fill}%
    % \includegraphics[width=40mm,alt={University of Edinburgh rondel}]{uoecrest.png}\par\SCHOOL\par%
    \vspace*{\fill}%
    \usebox{\staffbox}\\%
    \vspace*{\fill}%
    % \normalfont\titlepageFontSerif\Large\SCHOOL\par%
    \includegraphics[height=3\baselineskip,alt={School of Informatics, University of Edinburgh logo}]{\logofile}\par%
    \vspace*{\fill}
  \end{singlespace}%
  \thispagestyle{titlepage}%
\restoregeometry%
