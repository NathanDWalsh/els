% Don't just add packages blindly:
% first check whether a package is already loaded
% then check a package's instructions to see whether it needs to be loaded
% before of after specific other packages, typically biblatex or hyperref

% This command specifies the logo: the one to use depends on the page colour.
\newcommand*{\logofile}{InformaticsLogoColour}


\usepackage[immediate]{silence}

\usepackage{xcolor}% colour handling
\input{colours}
\AtBeginDocument{%
  \colorlet{defaultcolor}{.}% Capture the default color
}
\pagecolor{colorPage}\color{colorText}%


% Set the document's language and format for time and date
\usepackage{polyglossia}
\setmainlanguage[variant=uk]{english}

\usepackage{datetime2}
\DTMlangsetup[en-GB]{ord=omit,daymonthsep={\space}}
\DTMsetdatestyle{en-GB}
\DTMsettimestyle{iso}

\usepackage{
   adjustbox% gives alignment options to includegraphics; loads graphicx and varwidth
  ,afterpage% lets you specify the contents of the page after the current one
  ,bm% bold maths font
  ,booktabs% for proper table layouts
  ,datatool% load data from CSV and TSV files
  ,enumitem% for typesetting lists (enumerate, itemize, description)
  %,footmisc% must be loaded after the setspace package
  ,fontspec% more control over fonts
  %,graphicx% enhanced graphics handling - LOADED BY adjustbox
  ,hologo% allows LaTeX logos to be used in more places without crashing compilation: \hologo{LaTeX}
  ,listings% for program code listings; you could use minted instead (it needs python)
  %,markdown% allows the use of markdown notation but can break enumerate and itemize in LaTeX
  ,microtype% improves font handling
  ,multicol% multiple columns of body text
  ,multirow% span table rows
  ,pdflscape% makes a page landscape in the pdf but oriented so the text is still the right way up on screen
  ,pdfpages% allows embedding other PDF documents in this one
  ,ragged2e% provides \RaggedRight which allows some hypenation unlike \raggedright
  ,setspace% control line spacing
  ,siunitx% for typesetting numbers and quantities
  ,snotez% sidenotes
  ,subcaption% is loaded by infthesis.cls and also loads the caption package
  ,titlesec% greater control over headings; must precede hyperref; configured to load pagestyles
  ,tocloft% greater control over tables of contents, figures, and tables
  %,varwidth% variable width minipages - LOADED BY adjustbox
  ,luaquotes% try to correct quote marks to curve the correct way
  ,linebreaker% use lua to improve line overflow
  ,widows-and-orphans% improves paragraph structuring
}
\usepackage{fnpct} % Footnote punctuation

% Setup some of those packages
\graphicspath{{./_images/}}% \includegraphics will now find files in the _images directory
\AtBeginDocument{\input{_pagestyles}}
\WaOsetup{check=warning,widows=prevent,orphans=prevent} % from widows-and-orphans package


\usepackage{pgfgantt}% Gantt charts

\WarningFilter{biblatex}{Patching footnotes failed}
\usepackage{biblatex}
\DeactivateWarningFilters[biblatex] % So nothing unrelated gets silenced

% Load after biblatex but before hyperref
\usepackage{xurl}% improved line-breaking inside urls + \urldef command

\usepackage{bookmark}% loads hyperref
% \AtBeginDocument{\bookmarksetup{startatroot}\bookmark[named=FirstPage, level=0]{Title page}\bookmarksetup{startatroot}}
\WarningFilter{hyperref}{Token not allowed in a PDF string (Unicode):}
\hypersetup{%
   pdfauthor=\texorpdfstring{\AUTHOR}{\AUTHOR}%
  ,pdftitle=\texorpdfstring{\TITLE}{\TITLE}%
  ,pdfsubject=\texorpdfstring{\SUBJECT}{\SUBJECT}%
  ,pdfkeywords=\texorpdfstring{\KEYWORDS, \TITLE, \AUTHOR, \SUBJECT, \SUPERVISOR, \SCHOOL, \INSTITUTION}{\KEYWORDS, \TITLE, \AUTHOR, \SUBJECT, \SUPERVISOR, \SCHOOL, \INSTITUTION}%
}
\DeactivateWarningFilters[hyperref] % So nothing unrelated gets silenced

% geometry should be loaded after hyperref
\usepackage{geometry}
\geometry{
    % a4paper
    ,left=20.8mm
    ,top=27.4mm
    ,headsep=2\baselineskip
    ,textwidth=132mm
    ,marginparsep=6.2mm
    ,marginparwidth=34.4mm
    ,textheight=49\baselineskip
    ,headheight=\baselineskip
}
\frenchspacing

\usepackage{
   cleveref% clever referencing of sections, tables, and figures: use \cref instead of \ref
  %,menukeys% typesetting menus and keystrokes
  ,tabularx% another type of table that is great for handling (long) lines of text  
}


% configure program listings
\lstset{% general command to set parameter(s)%
  ,basicstyle=\ttfamily\small% applied at the beginning of the listing
  ,commentstyle={\color{commentColour}}% style for comments
  ,identifierstyle={}% everything that is not a keyword, string, or comment
  ,keywordstyle={\bfseries\color{keywordColour}}% language-specific keywords
  ,stringstyle={\color{stringColour}}% typically things in quotes
  ,numberstyle={\tiny\color{lineno}}%
  ,numbers=left% line numbering position: keep away from the document numbering
  ,numbersep=2em% gap between line numbers and code
  ,firstnumber=auto%
  ,numberblanklines=true%
  ,numberbychapter=false% must precede \begin{document}
  ,numberfirstline=true%
  ,stepnumber=1% line number count increment
  ,breaklines=true%
  ,captionpos=b% b=bottom, t=top: match it to the settings of the caption package
  ,emptylines=1% squeeze multiple blank lines to this number
  ,extendedchars=true% tries to make LaTeX handle UTF file
  ,formfeed={\bigbreak}% formfeed characters are converted to this
  ,frameround=single%
  ,showspaces=false% converts spaces from an actual space to an open box ␣ U+2423
  ,showstringspaces=true% as showspaces but inside strings
  ,showtabs=false% prints tabs as an elongated open box ␣
  ,tabsize=2% the number of spaces each tab is worth
  ,upquote=false% true gives curved smart quotes
}

% Configure siunitx
\sisetup{detect-all
  ,group-minimum-digits=3% Western convention is groups of 3 digits
  ,mode = text
  %,text-font-command = \liningroman
}
% You can now say \qty{50}{\px} for 50 pixels
\DeclareSIUnit{\px}{px}% create a unit for pixels



\DefineBibliographyStrings{english}{
   backrefpage={cited on page~}% unnecessary if defined in package options
  ,backrefpages={cited on pages~}% unnecessary if defined in package options
}
% from https://tex.stackexchange.com/a/134281
\setcounter{biburllcpenalty}{7000}
\setcounter{biburlucpenalty}{8000}
\assignrefcontextentries[]{*}
\DeclareCiteCommand{\citeyear}
    {\usebibmacro{prenote}}
    {\bibhyperref{\printfield{year}}\bibhyperref{\printfield{extrayear}}}
    {\multicitedelim}
    {\usebibmacro{postnote}}

\DeclareCiteCommand{\citeyearpar}[\mkbibparens]
    {\usebibmacro{prenote}}
    {\bibhyperref{\printfield{year}}\bibhyperref{\printfield{extrayear}}}
    {\multicitedelim}
    {\usebibmacro{postnote}}


% Packages loaded late to try to preserver their integrity
\usepackage{
   extdash% gives you the symbol \=/ for a non-breaking hyphen (note it's an equals sign)
  ,footnotebackref% hyperlink from the footnote number back to the text
}

% Create an enumerated descriptions list that automatically counts descriptions
\newlength{\enumCountLen}\setlength{\enumCountLen}{2em}
% adapted by Brian Mitchell from https://tex.stackexchange.com/a/30035
\newcounter{descriptcount}
\newlist{enumdescript}{description}{1}
\setlist[enumdescript,1]{%
  before={\setcounter{descriptcount}{0}%
          \renewcommand*\thedescriptcount{\makebox[\enumCountLen][r]{\arabic{descriptcount}.}}}
  ,font=\bfseries\stepcounter{descriptcount}\thedescriptcount~}
\setlist[enumdescript,2]{%
  before={\setcounter{descriptcount}{0}%
          \renewcommand*\thedescriptcount{\roman{descriptcount}}}
  ,font=\bfseries\stepcounter{descriptcount}\thedescriptcount~}

% New column types for tables
% L is for multiline *L*eft-justified blocks of text that need to wrap and look better not fully justified. It's name reflect that it is a version of the l column type from the array package but uses the uppercase \RaggedRight instead
\newcolumntype{L}{>{\RaggedRight\arraybackslash}X}

% T is for typesetting numbers to *T*hree decimal places
\newcolumntype{T}{S[table-format=1.3,round-mode=places,round-precision=3]}


% Let's do some cool stuff

% Automatically add PDF bookmarks for tables and figures
% from https://tex.stackexchange.com/a/178548
\makeatletter
\pretocmd\endtable{%
  \bookmark[
    rellevel=1,
    keeplevel,
    dest=\@currentHref,
  ]{Table \thetable: \@currentlabelname}%
}{}{\errmessage{Patching \noexpand\endtable failed}}
\pretocmd\endfigure{%
  \bookmark[
    rellevel=1,
    keeplevel,
    dest=\@currentHref,
  ]{Figure \thefigure: \@currentlabelname}%
}{}{\errmessage{Patching \noexpand\endfigure failed}}
\makeatother

%\input{__tex/_fontSetup}
\input{_fontSetup}

\emergencystretch=1em
\hfuzz=1em% fewer warnings about under/overfull boxes

\newlength{\entireTextWidth}\setlength{\entireTextWidth}{\dimexpr\textwidth+\marginparsep+\marginparwidth}

% Lengths for landscape pages
\newlength{\lscapewidth}\setlength{\lscapewidth}{\textheight}
\newlength{\lscapeheight}\setlength{\lscapeheight}{\textwidth}

% Needed for drawing boxes in the Gantt chart key in the caption.
\newlength{\charHeight}\AtBeginDocument{\settoheight{\charHeight}{A}}

% This command is empty for now: you redefine it for each float (table or figure)
% to have the short caption that goes in the list of figures / tables.
\newcommand*{\thisCaption}{}


% You may comment out the next line to shorten the compile log
\listfiles% puts a list of files loaded (in order) near the end of the log file
